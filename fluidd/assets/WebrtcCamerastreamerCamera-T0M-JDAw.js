var f=Object.defineProperty;var S=(s,t,e)=>t in s?f(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var d=(s,t,e)=>S(s,typeof t!="symbol"?t+"":t,e);import{m as g,C as v,f as b,l as _,R as A,j as w,k as O}from"./index-CAoDjHKA.js";var P=Object.defineProperty,k=Object.getOwnPropertyDescriptor,y=(s,t,e,r)=>{for(var a=r>1?void 0:r?k(t,e):t,n=s.length-1,o;n>=0;n--)(o=s[n])&&(a=(r?o(t,e,a):o(a))||a);return r&&a&&P(t,e,a),a};let u=class extends g(v){constructor(){super(...arguments);d(this,"cameraVideo");d(this,"pc",null);d(this,"remoteId",null);d(this,"playbackAbortController",null);d(this,"sleepAbortController",null)}async loadStream(){var a,n;(a=this.pc)==null||a.close();const e=(n=this.playbackAbortController)==null?void 0:n.signal;if(!e||e.aborted)return;this.updateStatus("connecting");const r=this.buildAbsoluteUrl(this.camera.stream_url||"");this.updateRawCameraUrl(r.toString());try{const i=await(await fetch(r,{body:JSON.stringify({type:"request",iceServers:[{urls:["stun:stun.l.google.com:19302"]}],keepAlive:!0}),headers:{"Content-Type":"application/json"},method:"POST",signal:e})).json();this.remoteId="id"in i&&typeof i.id=="string"?i.id:null;const h={sdpSemantics:"unified-plan"};"iceServers"in i&&Array.isArray(i.iceServers)&&(h.iceServers=i.iceServers);const c=this.pc=new RTCPeerConnection(h);c.ondatachannel=l=>{const m=l.channel;m.label==="keepalive"&&(m.onmessage=()=>{m.send("pong")})},c.addTransceiver("video",{direction:"recvonly"}),c.ontrack=l=>{l.track.kind==="video"&&(this.cameraVideo.srcObject=l.streams[0])},h.iceServers&&(c.onicecandidate=async l=>{if(l.candidate)try{await fetch(r,{body:JSON.stringify({type:"remote_candidate",id:this.remoteId,candidates:[l.candidate]}),headers:{"Content-Type":"application/json"},method:"POST",signal:e})}catch(m){b.error("[WebrtcCamerastreamerCamera] onicecandidate",m)}}),await c.setRemoteDescription(i);const C=await c.createAnswer();await c.setLocalDescription(C);const p=c.localDescription;await(await fetch(r,{body:JSON.stringify({type:p==null?void 0:p.type,id:this.remoteId,sdp:p==null?void 0:p.sdp}),headers:{"Content-Type":"application/json"},method:"POST",signal:e})).json()}catch(o){b.error(`[WebrtcCamerastreamerCamera] failed to start playback "${this.camera.name}"`,o),this.onError()}}async onError(){var a,n,o;this.updateStatus("error"),(a=this.pc)==null||a.close(),this.pc=null;const e=(n=this.playbackAbortController)==null?void 0:n.signal;if(!e||e.aborted)return;(o=this.sleepAbortController)==null||o.abort();const r=this.sleepAbortController=new AbortController;try{const i=[e,r.signal];await _(2e3,AbortSignal.any(i)),this.loadStream()}catch{}}async startPlayback(){this.playbackAbortController=new AbortController,await this.loadStream()}stopPlayback(){var e,r;this.updateStatus("disconnected"),(e=this.playbackAbortController)==null||e.abort(),this.playbackAbortController=null,(r=this.pc)==null||r.close(),this.pc=null,this.cameraVideo.src="",this.cameraVideo.srcObject=null}};y([A("streamingElement")],u.prototype,"cameraVideo",2);u=y([w({})],u);var j=function(){var t=this,e=t._self._c;return t._self._setupProxy,e("video",{ref:"streamingElement",style:t.cameraStyle,attrs:{autoplay:"",playsinline:"",muted:"",crossorigin:t.crossorigin},domProps:{muted:!0},on:{play:function(r){return t.updateStatus("connected")},error:function(r){return t.updateStatus("error")}}})},T=[],D=O(u,j,T,!1,null,null);const W=D.exports;export{W as default};
