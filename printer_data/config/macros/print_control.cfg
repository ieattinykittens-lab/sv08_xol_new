# ==================== PRINT CONTROL MACROS ====================
# ==================== macros/print_control.cfg ====================
# Main print control operations: start, end, pause, resume, cancel

[gcode_macro _APPLY_BEACON_MATERIAL_OFFSET]
description: Apply material-specific Z offset to Beacon model
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set offsets = printer['gcode_macro _global_var'].beacon_material_offsets %}
    {% set offset = offsets[material]|default(0.0)|float %}
    
    {% if offset != 0.0 %}
        _LOG_STATUS MSG="Applying {material} offset: {offset}mm to Beacon model" LED=busy
        SET_GCODE_OFFSET Z={offset}
        Z_OFFSET_APPLY_PROBE
        SET_GCODE_OFFSET Z=0
        _LOG_STATUS MSG="Beacon model updated with {material} offset" LED=ready
    {% else %}
        _LOG_STATUS MSG="No offset required for {material}" LED=ready
    {% endif %}

[gcode_macro START_PRINT]
description: Optimized start print sequence with material-based chamber control and Beacon proximity meshing
variable_state: 'Prepare'
variable_record_extruder_temp: 0
variable_max_record_extruder_temp: 0
gcode:
    status_busy

    {% set bedtemp = params.BED_TEMP|default(60)|int %}
    {% set hotendtemp = params.EXTRUDER_TEMP|default(230)|int %}
    {% set heatsoak = params.HEATSOAK|default(true)|int %}
    {% set material = params.MATERIAL|default("PLA")|string|upper %}

    # Get chamber target from material lookup table
    {% set filament_temps = printer['gcode_macro _global_var'].filament_chamber_temps %}
    {% set chamber_target = filament_temps[material]|default(0) %}
    _LOG_STATUS MSG="Material={material}, Chamber target={chamber_target}°C"

    {% set prime_amount = printer['gcode_macro _global_var'].prime_amount|float %}

    # Clear any previous M141 settings to avoid conflicts
    SET_GCODE_VARIABLE MACRO=_CHAMBER_CONTROL VARIABLE=target_temp VALUE=0

    M400
    CLEAR_PAUSE
    BED_MESH_CLEAR
    G90

    {% if state == 'Prepare' %}
        _LOG_STATUS MSG="Preparing printer for {material} print (chamber: {chamber_target}°C)" LED=busy

        # For materials requiring chamber heating, do chamber conditioning FIRST
        {% if chamber_target > 0 and heatsoak == true %}
            # Set bed to proper temperature for chamber heating (100°C minimum for enclosed materials)
            {% set chamber_bed_temp = [bedtemp, 100]|max %}
            _LOG_STATUS MSG="Starting bed heating for chamber conditioning"
            status_heating PULSE=1
            M140 S{chamber_bed_temp}

            {% if printer.heater_bed.temperature < chamber_bed_temp %}
                _LOG_STATUS MSG="Waiting for bed to reach {chamber_bed_temp}°C for chamber heating"
                status_heating PULSE=1
                M190 S{chamber_bed_temp}
            {% endif %}

            # Do chamber conditioning with heat soak
            _HEAT_SOAK_CHAMBER BED_TEMP={chamber_bed_temp} MATERIAL={material} CHAMBER={chamber_target}

        {% else %}
            # No chamber heating required - start bed heating
            _LOG_STATUS MSG="Starting bed heating (no chamber required)"
            status_heating PULSE=1
            M140 S{bedtemp}

            {% if printer.heater_bed.temperature < bedtemp %}
                _LOG_STATUS MSG="Waiting for bed to reach {bedtemp}°C"
                status_heating PULSE=1
                M190 S{bedtemp}
            {% endif %}

            {% if heatsoak == true %}
                _HEAT_SOAK_CHAMBER BED_TEMP={bedtemp} MATERIAL={material} CHAMBER={chamber_target}
            {% endif %}
        {% endif %}

        # Heat nozzle to 150°C for accurate probing and cleaning
        _LOG_STATUS MSG="Heating nozzle to 150°C for probe operations"
        status_heating PULSE=1
        M109 S150

        # Ensure X/Y are homed before any Z operations
        {% if "xy" not in printer.toolhead.homed_axes %}
            _LOG_STATUS MSG="Homing X/Y axes" LED=homing
            G28 X Y
        {% endif %}

        # QGL with proximity probing for speed
        {% if printer.quad_gantry_level.applied|lower != 'true' %}
            _LOG_STATUS MSG="Performing quad gantry leveling" LED=leveling
            QUAD_GANTRY_LEVEL PROBE_METHOD=proximity
        {% endif %}

        # Non-tap home after QGL (always runs)
        _LOG_STATUS MSG="Proximity home after QGL" LED=homing
        G28 Z METHOD=proximity

        # Clean nozzle
        _LOG_STATUS MSG="Starting nozzle cleaning" LED=cleaning
        #CLEAN_NOZZLE

        # Final tap home (contact calibrate) after cleaning
        _LOG_STATUS MSG="Post-clean contact calibration" LED=busy
        G28 Z METHOD=contact CALIBRATE=1

        # Apply material-specific offset after final calibration
        _APPLY_BEACON_MATERIAL_OFFSET MATERIAL={material}

        # Use proximity (scan mode) for fast, accurate bed meshing
        _LOG_STATUS MSG="Beacon proximity bed meshing (scan mode)" LED=meshing
        BED_MESH_CALIBRATE ADAPTIVE=1 PROBE_METHOD=proximity

        # Force mesh save/load for consistency
        BED_MESH_PROFILE SAVE=adaptivemesh
        BED_MESH_PROFILE LOAD=adaptivemesh

        M400

        _LOG_STATUS MSG="Smart parking" LED=busy
        SMART_PARK

        # Heat nozzle to print temperature after all probing
        _LOG_STATUS MSG="Heating nozzle to {hotendtemp}°C for printing"
        status_heating PULSE=1
        M109 S{hotendtemp}

        _LOG_STATUS MSG="Priming nozzle with {prime_amount}mm of filament" LED=busy
        G1 E{prime_amount} F300

        _LOG_STATUS MSG="Performing line purge" LED=busy
        LINE_PURGE

        # Set LED to printing status (white)
        status_printing
        _LOG_STATUS MSG="Print started successfully"
    {% endif %}

[gcode_macro END_PRINT]
description: Print completion sequence with LED status
variable_state: 'normal'
gcode:
    {% set z_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance|int %}
    {% set e_mintemp = printer.configfile.settings['extruder'].min_extrude_temp %}

    status_busy
    M400
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=record_extruder_temp VALUE=0
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=max_record_extruder_temp VALUE=0

    _LOG_STATUS MSG="Print completed - finalizing" LED=busy
    G91
    {% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
          printer.extruder.temperature >= e_mintemp
    %}
        G1 E-2 F2700
        G1 E-2 Z0.2 F2400
    {% endif %}

    {% if (printer.gcode_move.position.z + 25) < z_max %}
        G1 Z+25 F3000
    {% else %}
        G1 Z+{(z_max - printer.gcode_move.position.z)} F3000
    {% endif %}
    G90
    G1 X0 Y348 F9000

    _ALL_FAN_OFF
    TURN_OFF_HEATERS

    M84 X Y Z E
    M220 S100
    M221 S100

    CLEAR_PAUSE
    BED_MESH_CLEAR

    # Set to bright green (completed) and hold it for 5 seconds, then go to white
    status_completed
    _LOG_STATUS MSG="Print completed successfully - printer ready"
    G4 P5000
    status_white

[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
variable_state: 'normal'
gcode:
    {% if printer.pause_resume.is_paused == False %}
        {% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
        {% set filament_change_retract = printer['gcode_macro _global_var'].filament_change_retract|float %}
        {% set unload_retract = printer['gcode_macro _global_var'].unload_retract_amount|float %}

        {% set state = params.STATE if 'filament_change' in params.STATE else 'normal' %}

        _LOG_STATUS MSG="Pausing print - state: {state}" LED=paused

        PAUSE_BASE
        status_paused

        PARK_FOR_PAUSE

        M104 S{printer.extruder.target}

        {% if state == 'normal' %}
            {% if (printer.extruder.temperature + 5 >= printer.extruder.target) and (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
                G91
                G1 E-{e_restract} F300
                G90
            {% endif %}
        {% elif state == 'filament_change' %}
            {% if (printer.extruder.temperature + 5 >= printer.extruder.target) and (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
                G91
                G1 E+{filament_change_retract} F300
                G1 E-10 F1500
                G1 E-20 F600
                M400
                G4 P3000
                G1 E-{unload_retract} F300
                G90
            {% endif %}
        {% endif %}

        _LOG_STATUS MSG="Print paused successfully" LED=paused
    {% else %}
        _LOG_WARNING MSG="Print already paused"
    {% endif %}

[gcode_macro RESUME]
description: Resume the actual running print with LED status
rename_existing: RESUME_BASE
variable_state: 'normal'
gcode:
    {% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
    {% set load_prime = printer['gcode_macro _global_var'].load_prime_amount|float %}
    {% set extruder_target_temp = printer.extruder.target|int %}

    {% set state = params.STATE if 'filament_change' in params.STATE else 'normal' %}

    {% if state == 'filament_change' %}
        {% if printer.extruder.temperature + 5 >= printer.extruder.target %}
            status_busy
            G91
            G1 E{load_prime} F300
            G1 E10 F150
            G90
        {% else %}
            M104 S{extruder_target_temp}
            _LOG_STATUS MSG="Heating nozzle to {extruder_target_temp}°C for filament change"
            status_heating PULSE=1
            M109 S{extruder_target_temp}
            G91
            G1 E{load_prime} F300
            G1 E10 F150
            G90
        {% endif %}
        status_printing
        _LOG_STATUS MSG="Resuming print after filament change"
        RESUME_BASE
    {% elif state == 'normal' %}
        G91
        G1 E{e_restract} F300
        G90
        status_printing
        _LOG_STATUS MSG="Resuming print from pause"
        RESUME_BASE
        #SET_FAN_SPEED FAN=hotend_cooling_fan SPEED={printer['gcode_macro _global_var'].hotend_cooling_fan_speed}
    {% endif %}

[gcode_macro CANCEL_PRINT]
description: Cancel print with LED status
rename_existing: CANCEL_PRINT_BASE
gcode:
    {% set e_restract = printer['gcode_macro _global_var'].cancel_park.e|float %}
    {% set e_mintemp = printer.configfile.settings['extruder'].min_extrude_temp %}

    CANCEL_PRINT_BASE
    status_busy

    _LOG_STATUS MSG="Print cancellation initiated" LED=busy
    G91
    {% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
          printer.extruder.temperature >= e_mintemp
    %}
        G1 E-{e_restract} F500
    {% else %}
        _LOG_WARNING MSG="Nozzle not hot enough for retraction"
    {% endif %}

    PARK_FOR_CANCEL

    TURN_OFF_HEATERS
    _ALL_FAN_OFF

    CLEAR_PAUSE
    M84 X Y Z E

    _LOG_STATUS MSG="Print cancelled successfully - printer ready" LED=ready
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=record_extruder_temp VALUE=0
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=max_record_extruder_temp VALUE=0

[gcode_macro M600]
gcode:
    PAUSE STATE=filament_change

# ==================== BEACON UTILITY MACROS ====================

[gcode_macro BEACON_ACCURACY_TEST]
description: Run probe accuracy test with current Beacon setup
gcode:
    {% set samples = params.SAMPLES|default(10)|int %}
    _LOG_STATUS MSG="Running Beacon accuracy test ({samples} samples)" LED=busy
    PROBE_ACCURACY SAMPLES={samples} PROBE_METHOD=proximity
    _LOG_STATUS MSG="Beacon accuracy test completed" LED=ready

[gcode_macro BEACON_CONTACT_ACCURACY_TEST]
description: Run contact probe accuracy test
gcode:
    {% set samples = params.SAMPLES|default(10)|int %}
    _LOG_STATUS MSG="Running Beacon contact accuracy test ({samples} samples)" LED=busy
    PROBE_ACCURACY SAMPLES={samples} PROBE_METHOD=contact
    _LOG_STATUS MSG="Beacon contact accuracy test completed" LED=ready