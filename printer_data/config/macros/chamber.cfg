# ==================== CHAMBER TEMPERATURE CONTROL ====================
# ==================== macros/chamber.cfg ====================
# Chamber heating, temperature control, and heat soak operations

[gcode_macro M141]
description: Set chamber temperature
gcode:
    {% set target_temp = params.S|default(0)|float %}
    SET_GCODE_VARIABLE MACRO=_CHAMBER_CONTROL VARIABLE=target_temp VALUE={target_temp}
    {% if target_temp == 0 %}
        _LOG_STATUS MSG="Chamber heating disabled"
    {% else %}
        _LOG_STATUS MSG="Chamber target temperature set to {target_temp}°C"
    {% endif %}

[gcode_macro M191]
description: Wait for chamber temperature with pulsing
gcode:
    {% set target_temp = params.S|default(0)|float %}
    {% if target_temp == 0 %}
        _LOG_STATUS MSG="Chamber heating disabled"
        status_ready
    {% else %}
        {% set current_temp = printer["temperature_sensor chamber"].temperature %}
        
        {% if target_temp <= current_temp %}
            _LOG_STATUS MSG="Chamber already at target"
            status_ready
        {% else %}
            # Start pulsing during chamber heating
            status_heating PULSE=1
            _LOG_STATUS MSG="Waiting for chamber to reach {target_temp}°C"
            
            _CHAMBER_HEAT_AND_WAIT TARGET={target_temp}
            
            # Stop pulsing when done
            _LOG_STATUS MSG="Chamber reached target temperature"
            status_ready
        {% endif %}
    {% endif %}

[gcode_macro _CHAMBER_CONTROL]
description: Chamber control state variable
variable_target_temp: 0
gcode:

[gcode_macro _CHAMBER_HEAT_AND_WAIT]
description: Chamber heating with progress updates and bed heating
gcode:
    {% set target_temp = params.TARGET|float %}
    {% set current_temp = printer["temperature_sensor chamber"].temperature %}
    
    # Set bed to 100°C for chamber heating (or current target if higher)
    {% set chamber_bed_temp = [printer.heater_bed.target, 100]|max %}
    M140 S{chamber_bed_temp}
    
    # Start nevermore fans at slow speed for chamber heating
    NEVERMORE_SLOW
    
    # Progress reporting for long heating cycles (no LED status changes here)
    {% set temp_diff = target_temp - current_temp %}
    {% if temp_diff > 10 %}
        {% set progress_interval = 5 %}
        {% set next_milestone = (current_temp + progress_interval)|round(0) %}
        
        {% for milestone in range(next_milestone|int, target_temp|int, progress_interval) %}
            M117 Chamber: {milestone}°C / {target_temp}°C
            TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={milestone}
        {% endfor %}
    {% endif %}
    
    TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_temp}

[gcode_macro _HEAT_SOAK_CHAMBER]
description: Material-specific heat soak with proper bed heating
gcode:
    {% set bedtemp = params.BED_TEMP|int %}
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set chamber_target = params.CHAMBER|float %}
    {% set heatsoak_time = printer['gcode_macro _global_var'].heat_soak_time|default(3)|int %}
    
    {% set current_chamber_temp = printer["temperature_sensor chamber"].temperature %}
    
    {% if material == "PLA" %}
        # PLA: Simple heat soak with pulsing, no chamber heating, no nozzle heating
        status_heating PULSE=1
        _LOG_STATUS MSG="{material} heat soak ({heatsoak_time} min) - no chamber heating"
        G4 P{heatsoak_time * 60 * 1000}
        # Don't call status_ready here - let the next macro handle LED change
        
    {% elif chamber_target == 0 %}
        # Material with no chamber requirement - no pulsing needed
        _LOG_STATUS MSG="{material} printing - no chamber heating required"
        
    {% else %}
        {% if current_chamber_temp >= chamber_target %}
            # Already at temp, but set bed to proper temperature for material heat soak
            {% set chamber_bed_temp = [bedtemp, 100]|max %}
            M140 S{chamber_bed_temp}
            
            status_heating PULSE=1
            _LOG_STATUS MSG="Chamber at {current_chamber_temp|round(1)}°C - {material} soak ({heatsoak_time} min) at {chamber_bed_temp}°C bed"
            G4 P{heatsoak_time * 60 * 1000}
            # Don't call status_ready here - let the next macro handle LED change
            
        {% else %}
            # Need to heat chamber - use pulsing and proper bed heating
            status_heating PULSE=1
            _LOG_STATUS MSG="Heating chamber from {current_chamber_temp|round(1)}°C to {chamber_target}°C for {material}"
            
            # Heat chamber with bed and nevermore - _CHAMBER_HEAT_AND_WAIT handles bed and nevermore setup
            _CHAMBER_HEAT_AND_WAIT TARGET={chamber_target}
            
            _LOG_STATUS MSG="Chamber heating completed for {material}"
            # Don't call status_ready here - let the next macro handle LED change
        {% endif %}
        
        # Set nevermore for printing based on material
        {% if material not in ["PLA", "PETG"] %}
            NEVERMORE_FAST
        {% else %}
            NEVERMORE_OFF
        {% endif %}
    {% endif %}