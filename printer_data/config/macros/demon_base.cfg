[gcode_macro _CONDITIONAL_HOME]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}

    _SET_Z_PARK
  {% if "xyz" not in printer.toolhead.homed_axes %}
    {% if start_vars.neopixel_led == True %}
      STATUS_HOMING
    {% endif %}

    SET_DISPLAY_TEXT MSG="Homing..."
    RESPOND TYPE=COMMAND MSG="Homing..."

    G28

  {% else %}
    {% if start_vars.klicky_probe == True %}
      _klicky_check
    {% endif %}
  {% endif %}
    M117
    M400

[gcode_macro _SET_Z_PARK]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}

  {% if start_vars.system_choose_z == True %}
    {% if 'bltouch' in printer.configfile.config %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE=25

    {% elif 'scanner' in printer %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE=25

    {% elif 'smart_effctor' in printer %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE=25

    {% elif 'probe_eddy_ng btt_eddy' in printer or 'probe_eddy_ng eddy' in printer %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE=15

    {% elif ('mcu eddy' in printer.configfile.config) or ('probe_eddy_current btt_eddy' in printer) or ('probe_eddy_current eddy' in printer) %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE=25

    {% elif start_vars.klicky_probe == True or (printer.configfile.config.stepper_z.endstop_pin != 'probe:z_virtual_endstop') or (printer.configfile.config.stepper_z.endstop_pin != 'probe: z_virtual_endstop') %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE=50

    {% else %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE=5
    {% endif %}

  {% else %}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE={start_vars.custom_park_z}
  {% endif %}
